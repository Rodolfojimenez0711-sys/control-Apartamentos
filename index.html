<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Control de Apartamentos</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial, sans-serif;
  background: #f3f4f6;
  padding: 20px;
  font-size: 18px;
}
h1 { text-align:center; }

.card {
  background: #fff;
  padding: 18px;
  border-radius: 14px;
  margin-bottom: 18px;
  box-shadow: 0 4px 12px rgba(0,0,0,.1);
}

input, button {
  padding: 12px;
  margin: 6px 0;
  font-size: 18px;
}

button {
  background: #2563eb;
  color: #fff;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}

.apartment {
  border: 2px solid #e5e7eb;
  border-radius: 14px;
  padding: 14px;
  margin-top: 14px;
  position: relative;
}

.delete-apartment {
  position: absolute;
  top: 10px;
  right: 12px;
  font-size: 22px;
  color: red;
  cursor: pointer;
}

.section-title {
  font-weight: bold;
  margin-top: 10px;
}

.row {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.row input { flex: 1; }

.item {
  display: flex;
  justify-content: space-between;
  background: #f9fafb;
  padding: 10px;
  border-radius: 8px;
  margin-top: 6px;
}

.total {
  font-weight: bold;
  margin-top: 10px;
}

.small {
  font-size: 14px;
  color: #555;
}
</style>
</head>

<body>

<h1>Control de Apartamentos</h1>

<div class="card">
  <h3>Agregar apartamento</h3>
  <input id="nuevoNombre" placeholder="Nombre del apartamento">
  <button onclick="agregarApartamento()">Agregar</button>
</div>

<div class="card">
  <button onclick="cambiarMoneda()">Cambiar moneda</button>
  <div id="monedaLabel"></div>
</div>

<div id="lista"></div>

<script>
/* ===============================
   CONFIGURACIÓN DE VERSIONES
================================ */
const DATA_VERSION = 1;
const STORAGE_KEY = "control_apartamentos_data";
const TIPO_CAMBIO = 520;

/* ===============================
   CARGA SEGURA DE DATOS
================================ */
function cargarDatos() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) {
    return {
      version: DATA_VERSION,
      moneda: "CRC",
      apartamentos: []
    };
  }

  try {
    const data = JSON.parse(raw);

    // Migraciones futuras aquí
    if (!data.version) data.version = 1;
    if (!data.moneda) data.moneda = "CRC";
    if (!Array.isArray(data.apartamentos)) data.apartamentos = [];

    data.apartamentos.forEach(a => {
      if (!a.ingresos) a.ingresos = [];
      if (!a.gastos) a.gastos = [];
    });

    return data;
  } catch {
    alert("Error al cargar datos. No se borró información.");
    return {
      version: DATA_VERSION,
      moneda: "CRC",
      apartamentos: []
    };
  }
}

let data = cargarDatos();

/* ===============================
   GUARDADO SEGURO
================================ */
function guardar() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

/* ===============================
   FORMATEO MONEDAS
================================ */
function formatoCRC(v) {
  return new Intl.NumberFormat("es-CR", {
    style: "currency",
    currency: "CRC",
    minimumFractionDigits: 0
  }).format(v);
}

function formatoUSD(v) {
  return new Intl.NumberFormat("en-US", {
    style: "currency",
    currency: "USD",
    minimumFractionDigits: 2
  }).format(v / TIPO_CAMBIO);
}

function mostrar(v) {
  return data.moneda === "CRC" ? formatoCRC(v) : formatoUSD(v);
}

/* ===============================
   FUNCIONES PRINCIPALES
================================ */
function cambiarMoneda() {
  data.moneda = data.moneda === "CRC" ? "USD" : "CRC";
  guardar();
  render();
}

function agregarApartamento() {
  if (!nuevoNombre.value) return;
  data.apartamentos.push({
    nombre: nuevoNombre.value,
    ingresos: [],
    gastos: []
  });
  nuevoNombre.value = "";
  guardar();
  render();
}

function agregarIngreso(i) {
  const monto = Number(document.getElementById(`ingMonto-${i}`).value || 0);
  const desc = document.getElementById(`ingDesc-${i}`).value;
  if (!monto) return;

  data.apartamentos[i].ingresos.push({ montoCRC: monto, desc });
  guardar();
  render();
}

function agregarGasto(i) {
  const monto = Number(document.getElementById(`gasMonto-${i}`).value || 0);
  const desc = document.getElementById(`gasDesc-${i}`).value;
  if (!monto) return;

  data.apartamentos[i].gastos.push({ montoCRC: monto, desc });
  guardar();
  render();
}

function eliminarApartamento(i) {
  if (confirm("¿Eliminar este apartamento completo?")) {
    data.apartamentos.splice(i, 1);
    guardar();
    render();
  }
}

function eliminarItem(tipo, i, j) {
  data.apartamentos[i][tipo].splice(j, 1);
  guardar();
  render();
}

function actualizarCampo(tipo, i, j, campo, v) {
  if (campo === "montoCRC") v = Number(v || 0);
  data.apartamentos[i][tipo][j][campo] = v;
  guardar();
  render();
}

function actualizarNombre(i, v) {
  data.apartamentos[i].nombre = v;
  guardar();
}

/* ===============================
   RENDER
================================ */
function render() {
  monedaLabel.innerText =
    data.moneda === "CRC" ? "Moneda: Colones ₡" : "Moneda: Dólares $";

  lista.innerHTML = "";

  data.apartamentos.forEach((a, i) => {
    const totalIng = a.ingresos.reduce((s, x) => s + x.montoCRC, 0);
    const totalGas = a.gastos.reduce((s, x) => s + x.montoCRC, 0);
    const ganancia = totalIng - totalGas;

    lista.innerHTML += `
      <div class="card apartment">
        <span class="delete-apartment" onclick="eliminarApartamento(${i})">✖</span>

        <input value="${a.nombre}" oninput="actualizarNombre(${i}, this.value)">

        <div class="section-title">Ingresos</div>
        <div class="row">
          <input id="ingMonto-${i}" type="number" inputmode="numeric" placeholder="Monto">
          <input id="ingDesc-${i}" placeholder="Descripción">
          <button onclick="agregarIngreso(${i})">+</button>
        </div>

        ${a.ingresos.map((x, j) => `
          <div class="item">
            <div>
              <input type="number" inputmode="numeric"
                value="${x.montoCRC}"
                oninput="actualizarCampo('ingresos',${i},${j},'montoCRC',this.value)">
              <input value="${x.desc}"
                oninput="actualizarCampo('ingresos',${i},${j},'desc',this.value)">
            </div>
            <span style="color:red;cursor:pointer"
              onclick="eliminarItem('ingresos',${i},${j})">✖</span>
          </div>
        `).join("")}

        <div class="section-title">Gastos</div>
        <div class="row">
          <input id="gasMonto-${i}" type="number" inputmode="numeric" placeholder="Monto">
          <input id="gasDesc-${i}" placeholder="Descripción">
          <button onclick="agregarGasto(${i})">+</button>
        </div>

        ${a.gastos.map((x, j) => `
          <div class="item">
            <div>
              <input type="number" inputmode="numeric"
                value="${x.montoCRC}"
                oninput="actualizarCampo('gastos',${i},${j},'montoCRC',this.value)">
              <input value="${x.desc}"
                oninput="actualizarCampo('gastos',${i},${j},'desc',this.value)">
            </div>
            <span style="color:red;cursor:pointer"
              onclick="eliminarItem('gastos',${i},${j})">✖</span>
          </div>
        `).join("")}

        <div class="total">Total ingresos: ${mostrar(totalIng)}</div>
        <div class="total">Total gastos: ${mostrar(totalGas)}</div>
        <div class="total">Ganancia: ${mostrar(ganancia)}</div>
      </div>
    `;
  });
}

render();
</script>

</body>
</html>