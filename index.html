<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Control de Apartamentos</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial, sans-serif;
  background: #f3f4f6;
  padding: 20px;
  font-size: 18px;
}

h1 { text-align: center; }

.card {
  background: #fff;
  padding: 18px;
  border-radius: 14px;
  margin-bottom: 18px;
  box-shadow: 0 4px 12px rgba(0,0,0,.1);
}

input, button {
  padding: 12px;
  margin: 6px 0;
  font-size: 18px;
}

button {
  background: #2563eb;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}

.apartment {
  border: 2px solid #e5e7eb;
  border-radius: 14px;
  padding: 14px;
  margin-top: 14px;
  position: relative;
}

.delete-apartment {
  position: absolute;
  top: 10px;
  right: 12px;
  font-size: 22px;
  color: red;
  cursor: pointer;
}

.section-title {
  font-weight: bold;
  margin-top: 12px;
}

.row {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.row input { flex: 1; }

.item {
  background: #f9fafb;
  padding: 10px;
  border-radius: 8px;
  margin-top: 6px;
}

.item-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.formatted {
  font-size: 14px;
  color: #2563eb;
  margin-top: 4px;
}

.total {
  font-weight: bold;
  margin-top: 8px;
}

.ganancia-positiva {
  color: #16a34a;
}

.ganancia-negativa {
  color: #dc2626;
}

.ganancia-cero {
  color: #374151;
}
</style>
</head>

<body>

<h1>Control de Apartamentos</h1>

<div class="card">
  <h3>Agregar apartamento (máx. 30)</h3>
  <input id="nuevoNombre" placeholder="Nombre del apartamento">
  <button onclick="agregarApartamento()">Agregar</button>
</div>

<div class="card">
  <button onclick="cambiarMoneda()">Cambiar moneda</button>
  <div id="monedaLabel"></div>
</div>

<div id="lista"></div>

<script>
const STORAGE_KEY = "control_apartamentos_data";
const TIPO_CAMBIO = 520;
const MAX_APARTAMENTOS = 30;

let data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
  version: 1,
  moneda: "CRC",
  apartamentos: []
};

function guardar() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

function formatoCRC(v) {
  return new Intl.NumberFormat("es-CR", {
    style: "currency",
    currency: "CRC",
    minimumFractionDigits: 0
  }).format(v);
}

function formatoUSD(v) {
  return new Intl.NumberFormat("en-US", {
    style: "currency",
    currency: "USD",
    minimumFractionDigits: 2
  }).format(v / TIPO_CAMBIO);
}

function mostrar(v) {
  return data.moneda === "CRC" ? formatoCRC(v) : formatoUSD(v);
}

function cambiarMoneda() {
  data.moneda = data.moneda === "CRC" ? "USD" : "CRC";
  guardar();
  render();
}

function agregarApartamento() {
  if (!nuevoNombre.value) return;

  if (data.apartamentos.length >= MAX_APARTAMENTOS) {
    alert("Solo se pueden agregar hasta 30 apartamentos.");
    return;
  }

  data.apartamentos.push({
    nombre: nuevoNombre.value,
    ingresos: [],
    gastos: []
  });

  nuevoNombre.value = "";
  guardar();
  render();
}

function agregarIngreso(i) {
  const m = Number(document.getElementById(`ingMonto-${i}`).value || 0);
  const d = document.getElementById(`ingDesc-${i}`).value;
  if (!m) return;

  data.apartamentos[i].ingresos.push({ montoCRC: m, desc: d });
  guardar();
  render();
}

function agregarGasto(i) {
  const m = Number(document.getElementById(`gasMonto-${i}`).value || 0);
  const d = document.getElementById(`gasDesc-${i}`).value;
  if (!m) return;

  data.apartamentos[i].gastos.push({ montoCRC: m, desc: d });
  guardar();
  render();
}

function eliminarItem(tipo, i, j) {
  data.apartamentos[i][tipo].splice(j, 1);
  guardar();
  render();
}

function actualizarCampo(tipo, i, j, campo, v) {
  if (campo === "montoCRC") v = Number(v || 0);
  data.apartamentos[i][tipo][j][campo] = v;
  guardar();
  render();
}

function eliminarApartamento(i) {
  if (confirm("¿Eliminar este apartamento completo?")) {
    data.apartamentos.splice(i, 1);
    guardar();
    render();
  }
}

function claseGanancia(v) {
  if (v > 0) return "ganancia-positiva";
  if (v < 0) return "ganancia-negativa";
  return "ganancia-cero";
}

function render() {
  monedaLabel.innerText =
    data.moneda === "CRC" ? "Moneda: Colones ₡" : "Moneda: Dólares $";

  lista.innerHTML = "";

  data.apartamentos.forEach((a, i) => {
    const totalIng = a.ingresos.reduce((s, x) => s + x.montoCRC, 0);
    const totalGas = a.gastos.reduce((s, x) => s + x.montoCRC, 0);
    const ganancia = totalIng - totalGas;

    lista.innerHTML += `
      <div class="card apartment">
        <span class="delete-apartment" onclick="eliminarApartamento(${i})">✖</span>

        <input value="${a.nombre}"
          oninput="data.apartamentos[${i}].nombre=this.value;guardar()">

        <div class="section-title">Ingresos</div>
        <div class="row">
          <input id="ingMonto-${i}" type="number" inputmode="numeric" placeholder="Monto ingreso">
          <input id="ingDesc-${i}" placeholder="Descripción ingreso">
          <button onclick="agregarIngreso(${i})">+</button>
        </div>

        ${a.ingresos.map((x, j) => `
          <div class="item">
            <input type="number" inputmode="numeric"
              value="${x.montoCRC}"
              oninput="actualizarCampo('ingresos',${i},${j},'montoCRC',this.value)">
            <div class="formatted">${mostrar(x.montoCRC)}</div>
            <input value="${x.desc}"
              oninput="actualizarCampo('ingresos',${i},${j},'desc',this.value)">
            <span style="color:red;cursor:pointer"
              onclick="eliminarItem('ingresos',${i},${j})">✖</span>
          </div>
        `).join("")}

        <div class="section-title">Gastos</div>
        <div class="row">
          <input id="gasMonto-${i}" type="number" inputmode="numeric" placeholder="Monto gasto">
          <input id="gasDesc-${i}" placeholder="Descripción gasto">
          <button onclick="agregarGasto(${i})">+</button>
        </div>

        ${a.gastos.map((x, j) => `
          <div class="item">
            <input type="number" inputmode="numeric"
              value="${x.montoCRC}"
              oninput="actualizarCampo('gastos',${i},${j},'montoCRC',this.value)">
            <div class="formatted">${mostrar(x.montoCRC)}</div>
            <input value="${x.desc}"
              oninput="actualizarCampo('gastos',${i},${j},'desc',this.value)">
            <span style="color:red;cursor:pointer"
              onclick="eliminarItem('gastos',${i},${j})">✖</span>
          </div>
        `).join("")}

        <div class="total">Total ingresos: ${mostrar(totalIng)}</div>
        <div class="total">Total gastos: ${mostrar(totalGas)}</div>
        <div class="total ${claseGanancia(ganancia)}">
          Ganancia: ${mostrar(ganancia)}
        </div>
      </div>
    `;
  });
}

render();
</script>

</body>
</html>